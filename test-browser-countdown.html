<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug - Countdown Timer</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #569cd6;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background: #005a9e;
        }
        .console {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            padding: 10px;
            height: 500px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .msg-type { color: #4ec9b0; }
        .msg-countdown { color: #ffd700; }
        .msg-state { color: #569cd6; }
        .msg-error { color: #f48771; }
        .msg-success { color: #6a9955; }
        .timestamp { color: #808080; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå WebSocket Debug Console - Countdown Timer Test</h1>
        
        <div class="controls">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
            <button onclick="triggerRinging()">üìû Trigger RINGING</button>
            <button onclick="answer()">‚úÖ Answer</button>
            <button onclick="hangup()">üìµ Hangup</button>
            <button onclick="clearConsole()">Clear Console</button>
        </div>
        
        <div class="console" id="console">
            <div class="msg-success">Ready to connect to WebSocket...</div>
            <div class="msg-success">Debug mode is now HARDCODED to true</div>
            <div class="msg-success">Countdown timer will always be shown for states with timeout</div>
        </div>
    </div>
    
    <script>
        let ws = null;
        const consoleEl = document.getElementById('console');
        
        function log(message, className = '') {
            const time = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.innerHTML = `<span class="timestamp">[${time}]</span> <span class="${className}">${escapeHtml(message)}</span>`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('Already connected', 'msg-error');
                return;
            }
            
            log('Connecting to ws://localhost:9998...', 'msg-success');
            ws = new WebSocket('ws://localhost:9998');
            
            ws.onopen = function() {
                log('‚úÖ Connected to WebSocket', 'msg-success');
                log('Opening browser DevTools Network tab will show WebSocket messages', 'msg-success');
            };
            
            ws.onmessage = function(event) {
                const msg = JSON.parse(event.data);
                
                // Format and display message based on type
                if (msg.type === 'TIMEOUT_COUNTDOWN') {
                    log(`‚è±Ô∏è  COUNTDOWN: ${msg.remainingSeconds}s remaining (State: ${msg.state}, Debug: ${msg.debugMode})`, 'msg-countdown');
                } else if (msg.type === 'STATE_CHANGE') {
                    log(`STATE_CHANGE: ${msg.stateBefore} ‚Üí ${msg.stateAfter}`, 'msg-state');
                } else {
                    log(`${msg.type}: ${JSON.stringify(msg)}`, 'msg-type');
                }
                
                // Also log raw message for debugging
                console.log('WebSocket message:', msg);
            };
            
            ws.onerror = function(error) {
                log('‚ùå WebSocket error', 'msg-error');
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = function() {
                log('Disconnected from WebSocket', 'msg-error');
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                log('Disconnected', 'msg-success');
            }
        }
        
        function triggerRinging() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Not connected', 'msg-error');
                return;
            }
            
            const message = {
                action: "INCOMING_CALL",
                payload: { callerNumber: "+1-555-BROWSER-TEST" }
            };
            
            ws.send(JSON.stringify(message));
            log(`Sent: ${JSON.stringify(message)}`, 'msg-success');
        }
        
        function answer() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Not connected', 'msg-error');
                return;
            }
            
            const message = { action: "ANSWER" };
            ws.send(JSON.stringify(message));
            log(`Sent: ${JSON.stringify(message)}`, 'msg-success');
        }
        
        function hangup() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('Not connected', 'msg-error');
                return;
            }
            
            const message = { action: "HANGUP" };
            ws.send(JSON.stringify(message));
            log(`Sent: ${JSON.stringify(message)}`, 'msg-success');
        }
        
        function clearConsole() {
            consoleEl.innerHTML = '';
            log('Console cleared', 'msg-success');
        }
    </script>
</body>
</html>